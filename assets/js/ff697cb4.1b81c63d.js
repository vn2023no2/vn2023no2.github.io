"use strict";(self.webpackChunkvn_2023_no_2_github_io=self.webpackChunkvn_2023_no_2_github_io||[]).push([[1680],{8209:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>d,frontMatter:()=>c,metadata:()=>o,toc:()=>l});var r=t(5893),s=t(1151);const c={sidebar_position:1},i="Operators",o={id:"IT/prom-stack/prometheus",title:"Operators",description:"on - group_left",source:"@site/docs/IT/8-prom-stack/prometheus.md",sourceDirName:"IT/8-prom-stack",slug:"/IT/prom-stack/prometheus",permalink:"/docs/IT/prom-stack/prometheus",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IT/8-prom-stack/prometheus.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Prom-stack",permalink:"/docs/category/prom-stack"},next:{title:"Kubernetes",permalink:"/docs/IT/prom-stack/issue-with-prom-stack"}},a={},l=[{value:"on - group_left",id:"on---group_left",level:2},{value:"label_replace",id:"label_replace",level:2},{value:"\u0110\u1ed5i t\xean label",id:"\u0111\u1ed5i-t\xean-label",level:3},{value:"\u0110\u1ed5i gi\xe1 tr\u1ecb c\u1ee7a label (t\xe1ch IP)",id:"\u0111\u1ed5i-gi\xe1-tr\u1ecb-c\u1ee7a-label-t\xe1ch-ip",level:3},{value:"Counter",id:"counter",level:2},{value:"Gauge",id:"gauge",level:2},{value:"Histogram",id:"histogram",level:2},{value:"Summary",id:"summary",level:2}];function h(e){const n={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"operators",children:"Operators"}),"\n",(0,r.jsx)(n.h2,{id:"on---group_left",children:"on - group_left"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"on (instance, job) group_left (version, commit)"})," - this is Prometheus equivalent of a left join from SQL. It uses the instance and job labels, which are automatically added by Prometheus, to group join time series. It\u2019s then going to add the version and commit labels from the time series on the right to the series on the left.",(0,r.jsx)(n.br,{}),"\n","("]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["ch\u1ec9 \u0111\u01a1n gi\u1ea3n l\xe0 th\xeam label ",(0,r.jsx)(n.code,{children:"version, commit"})," v\xe0o danh s\xe1ch label c\u1ee7a metric b\xean tr\xe1i v\u1edbi nh\u1eefng metric c\xf3 instance v\xe0 label kh\u1edbp v\u1edbi nhau, kh\xe1 gi\u1ed1ng v\u1edbi left join trong SQL, nh\u01b0ng nh\u1eefng k\u1ebft qu\u1ea3 kh\xf4ng kh\u1edbp s\u1ebd b\u1ecb lo\u1ea1i b\u1ecf thay v\xec \u0111\u01b0\u1ee3c show nh\u01b0 SQL.\nK\u1ebft qu\u1ea3:"]}),"\n",(0,r.jsx)(n.li,{children:"metric b\xean tr\xe1i \u0111\u01b0\u1ee3c gi\u1eef nguy\xean value nh\u01b0ng b\u1ecf t\xean metric."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[")",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.strong,{children:"Chi ti\u1ebft h\u01a1n th\xec \u0111\u1ecdc d\u01b0\u1edbi \u0111\xe2y:"}),(0,r.jsx)(n.br,{}),"\n","\u0110i\u1ec1u n\xe0y cung c\u1ea5p cho ch\xfang ta c\xe1c li\xean k\u1ebft m\u1ed9t - m\u1ed9t b\xean trong v\u1edbi PromQL, nh\u01b0ng kh\xf4ng ph\u1ea3i c\xe1c li\xean k\u1ebft tr\xe1i. Ch\xfang ta c\u0169ng ch\u1ec9 c\xf3 c\xe1c label kh\u1edbp trong k\u1ebft qu\u1ea3. Tr\u01b0\u1edbc \u0111\xe2y ch\xfang ta \u0111\xe3 xem x\xe9t c\xe1ch th\u1ef1c hi\u1ec7n m\u1ed9t s\u1ed1 \u0111i\u1ec1u n\xe0y:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"a * on(foo, bar) group_left(baz) b\n"})}),"\n",(0,r.jsx)(n.p,{children:"t\u01b0\u01a1ng \u0111\u01b0\u01a1ng v\u1edbi"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"SELECT a.value * b.value, a.*, b.baz\nFROM a JOIN b ON (a.foo == b.foo AND a.bar == b.bar)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Ngh\u0129a l\xe0 ch\xfang ta gi\u1eef t\u1ea5t c\u1ea3 c\xe1c label \u1edf ph\xeda b\xean tr\xe1i, v\xe0 th\xeam ",(0,r.jsx)(n.code,{children:"baz"})," label \u1edf ph\xeda b\xean ph\u1ea3i c\u1ee7a to\xe1n t\u1eed. \u0110\xe2y c\u0169ng l\xe0 ph\xe9p so kh\u1edbp nhi\u1ec1u - m\u1ed9t, do \u0111\xf3 c\xf3 th\u1ec3 c\xf3 nhi\u1ec1u m\u1eabu \u1edf ph\xeda b\xean tr\xe1i c\xf3 c\xf9ng label ",(0,r.jsx)(n.code,{children:"foo"})," v\xe0 ",(0,r.jsx)(n.code,{children:"bar"})," s\u1ebd t\u01b0\u01a1ng \u1ee9ng v\u1edbi m\u1ed9t gi\xe1 tr\u1ecb \u1edf b\xean ph\u1ea3i."]}),"\n",(0,r.jsx)(n.h2,{id:"label_replace",children:"label_replace"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'label_replace(metric{...}, "label-name-new", "$1", "label-name-current", "regex")\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u0111\u1ed5i-t\xean-label",children:"\u0110\u1ed5i t\xean label"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'label_replace(metric{...}, "label-name-new", "$1", "label-name-current", "(.+)")\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u0111\u1ed5i-gi\xe1-tr\u1ecb-c\u1ee7a-label-t\xe1ch-ip",children:"\u0110\u1ed5i gi\xe1 tr\u1ecb c\u1ee7a label (t\xe1ch IP)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'label_replace(metric{...}, "label-name-new", "$1", "label-name-current", "(.*):(.*)")\n'})}),"\n",(0,r.jsx)(n.p,{children:"Ex:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'process_cpu_seconds_total{cluster_num="1", instance="1.1.1.1:9113", job="vmagent"}\n\n==> label_replace(process_cpu_seconds_total, "pod_ip", "$1", "instance", "(.*):(.*)") ==>\n\nprocess_cpu_seconds_total{cluster_num="1", instance="1.1.1.1:9113", job="vmagent", pod_ip="1.1.1.1"}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"References:"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.a,{href:"https://prometheus.io/docs/prometheus/latest/querying/operators/",children:"https://prometheus.io/docs/prometheus/latest/querying/operators/"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.a,{href:"https://autometrics.dev/blog/inside-some-complex-prometheus-queries",children:"https://autometrics.dev/blog/inside-some-complex-prometheus-queries"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.a,{href:"https://www.robustperception.io/left-joins-in-promql/",children:"https://www.robustperception.io/left-joins-in-promql/"})]}),"\n",(0,r.jsx)(n.h1,{id:"functions",children:"Functions"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"increase"})," function - t\xednh to\xe1n t\u1ed1c \u0111\u1ed9 thay \u0111\u1ed5i c\u1ee7a metric.\n",(0,r.jsx)(n.code,{children:"rate"})," function - t\xednh to\xe1n t\u1ed1c \u0111\u1ed9 thay \u0111\u1ed5i ",(0,r.jsx)(n.code,{children:"theo gi\xe2y"})," c\u1ee7a metric."]}),"\n",(0,r.jsx)(n.p,{children:"B\u1ea3ng s\u1ed1 li\u1ec7u m\u1eabu"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Time Count increase  rate(count[1m])\n15s  4381  0          0\n30s  4381  0          0\n45s  4381  0          0\n1m   4381  0          0\n\n15s  4381  0          0\n30s  4402  21         0.700023\n45s  4402  0          0.700023\n2m   4423  21         0.7\n\n15s  4423  0          0.7\n30s  4440  17         0.56666666\n45s  4440  0          0.56666666\n3m   4456  16         0.53333333\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"increase[30s] = count at 2m - count at 1.5m = 4423 - 4402 = 21   \nrate[1m]      = (count at 2m - count at 1m) / 60 = (4423 - 4381) / 60 = 0.7\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"H\xe0m `increase` v\xe0 `rate` s\u1ebd tr\u1ea3 v\u1ec1 k\u1ebft qu\u1ea3 `Empty query result` n\u1ebfu trong kho\u1ea3ng th\u1eddi gian [t] metric [c] kh\xf4ng bao ph\u1ee7 \xedt nh\u1ea5t 2 samples. V\xec v\u1eady h\xe3y xem x\xe9t t\u0103ng kho\u1ea3ng th\u1eddi gian l\xean \u0111\u1ec3 c\xf3 th\u1ec3 t\xednh to\xe1n \u0111\u01b0\u1ee3c.   \n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"Reference:"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.a,{href:"https://prometheus.io/docs/prometheus/latest/querying/functions/",children:"https://prometheus.io/docs/prometheus/latest/querying/functions/"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.a,{href:"https://stackoverflow.com/a/71662506/14312225",children:"https://stackoverflow.com/a/71662506/14312225"})]}),"\n",(0,r.jsx)(n.h1,{id:"service-discovery",children:"Service Discovery"}),"\n",(0,r.jsx)(n.p,{children:"Service discovery is a fundamental concept in Prometheus architecture. It allows Prometheus to automatically discover and monitor targets (systems or services) without requiring manual configuration for each individual target."}),"\n",(0,r.jsx)(n.p,{children:"Kubernetes is the perfect example for dynamic targets. Here, you cannot use the static targets method, because targets (pods) in a Kubernetes cluster is ephemeral in nature and could be short lived."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"scrape_configs:\n    - job_name: 'kubernetes-apiservers'\n    kubernetes_sd_configs:\n    - role: endpoints\n    scheme: https\n    tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n        action: keep\n        regex: default;kubernetes;https\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"Reference:"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.a,{href:"https://medium.com/@tech_18484/understand-prometheus-architecture-1ab83afd53b8",children:"https://medium.com/@tech_18484/understand-prometheus-architecture-1ab83afd53b8"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.a,{href:"https://devopscube.com/prometheus-architecture/",children:"https://devopscube.com/prometheus-architecture/"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.a,{href:"https://devalpharm.medium.com/deploying-prometheus-and-grafana-on-kubernetes-using-manifest-files-3761792d12a4",children:"https://devalpharm.medium.com/deploying-prometheus-and-grafana-on-kubernetes-using-manifest-files-3761792d12a4"})]}),"\n",(0,r.jsx)(n.h1,{id:"metric-types-4-lo\u1ea1i",children:"Metric types (4 lo\u1ea1i)"}),"\n",(0,r.jsx)(n.h2,{id:"counter",children:"Counter"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Kh\xf4ng d\xf9ng cho c\xe1c metric c\xf3 th\u1ec3 gi\u1ea3m theo th\u1eddi gian."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"gauge",children:"Gauge"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"D\xf9ng cho c\xe1c metric c\xf3 th\u1ec3 t\u0103ng ho\u1eb7c gi\u1ea3m theo th\u1eddi gian."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"histogram",children:"Histogram"}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"Reference:"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.a,{href:"https://prometheus.io/docs/concepts/metric_types/",children:"https://prometheus.io/docs/concepts/metric_types/"})]})]})}function d(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>o,a:()=>i});var r=t(7294);const s={},c=r.createContext(s);function i(e){const n=r.useContext(c);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(c.Provider,{value:n},e.children)}}}]);