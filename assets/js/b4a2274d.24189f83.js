"use strict";(self.webpackChunkvn_2023_no_2_github_io=self.webpackChunkvn_2023_no_2_github_io||[]).push([[133],{1469:(e,n,c)=>{c.r(n),c.d(n,{assets:()=>h,contentTitle:()=>i,default:()=>a,frontMatter:()=>s,metadata:()=>o,toc:()=>d});var t=c(4848),r=c(8453);const s={sidebar_position:3},i="1. Authentication",o={id:"IT/kubernetes/service-account-rbac",title:"service-account-rbac",description:"Gi\u1ed1ng nh\u01b0 b\u1ea5t k\u1ef3 h\u1ec7 th\u1ed1ng n\xe0o kh\xe1c, Kubernetes c\u0169ng cung c\u1ea5p cho ch\xfang ta h\u1ec7 th\u1ed1ng Authentication (X\xe1c th\u1ef1c) v\xe0 Authorization (Ph\xe2n quy\u1ec1n) gi\xfap \u0111\u1ea3m b\u1ea3o t\xednh b\u1ea3o m\u1eadt v\xe0 qu\u1ea3n l\xfd truy c\u1eadp \u0111\u1ed1i v\u1edbi c\xe1c ngu\u1ed3n t\xe0i nguy\xean trong cluster.",source:"@site/docs/IT/5-kubernetes/service-account-rbac.md",sourceDirName:"IT/5-kubernetes",slug:"/IT/kubernetes/service-account-rbac",permalink:"/docs/IT/kubernetes/service-account-rbac",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IT/5-kubernetes/service-account-rbac.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Metrics",permalink:"/docs/IT/kubernetes/monitor-for-ingress-nginx"},next:{title:"1. Stiky session?",permalink:"/docs/IT/kubernetes/sticky-session"}},h={},d=[{value:"Service Account",id:"service-account",level:2},{value:"External Service",id:"external-service",level:2},{value:"2.1 Action",id:"21-action",level:2},{value:"2.2 C\xe1c resource \u0111\u1ec3 \u0111\u1ecbnh ngh\u0129a RBAC",id:"22-c\xe1c-resource-\u0111\u1ec3-\u0111\u1ecbnh-ngh\u0129a-rbac",level:2},{value:"3.1 T\u1ea1o user trong K8S v\u1edbi ServiceAccount, Role, RoleBinding",id:"31-t\u1ea1o-user-trong-k8s-v\u1edbi-serviceaccount-role-rolebinding",level:2},{value:"3.2 T\u1ea1o user trong K8S v\u1edbi Certificate, Role, RoleBinding",id:"32-t\u1ea1o-user-trong-k8s-v\u1edbi-certificate-role-rolebinding",level:2}];function l(e){const n={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["Gi\u1ed1ng nh\u01b0 b\u1ea5t k\u1ef3 h\u1ec7 th\u1ed1ng n\xe0o kh\xe1c, Kubernetes c\u0169ng cung c\u1ea5p cho ch\xfang ta h\u1ec7 th\u1ed1ng Authentication (X\xe1c th\u1ef1c) v\xe0 Authorization (Ph\xe2n quy\u1ec1n) gi\xfap \u0111\u1ea3m b\u1ea3o t\xednh b\u1ea3o m\u1eadt v\xe0 qu\u1ea3n l\xfd truy c\u1eadp \u0111\u1ed1i v\u1edbi c\xe1c ngu\u1ed3n t\xe0i nguy\xean trong cluster.",(0,t.jsx)(n.br,{}),"\n","B\xe0i vi\u1ebft n\xe0y s\u1ebd gi\xfap b\u1ea1n hi\u1ec3u \u0111\u01b0\u1ee3c c\xe1ch user \u0111\u01b0\u1ee3c authentication v\xe0 authorization trong Kubernetes cluster.",(0,t.jsx)(n.br,{}),"\n","\u0110\xe2y l\xe0 c\xe1c d\u1ecbch v\u1ee5 gi\xfap ch\xfang ta th\u1ef1c hi\u1ec7n 2 vi\u1ec7c \u0111\xf3 trong K8S."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Authentication (x\xe1c th\u1ef1c)   ==> S\u1eed d\u1ee5ng Service Account (authentication qua token, \u0111\xe2y l\xe0 c\xe1ch authentication duy nh\u1ea5t \u0111\u01b0\u1ee3c qu\u1ea3n l\xfd b\u1edfi K8S).      \n                            ==> S\u1eed d\u1ee5ng c\xe1c `external service` \u0111\u1ec3 x\xe1c th\u1ef1c v\u1edbi K8S Cluster.      \nAuthorization (ph\xe2n quy\u1ec1n)  ==> S\u1eed d\u1ee5ng RBAC (Role Based Access Control).        \n"})}),"\n",(0,t.jsx)(n.h1,{id:"1-authentication",children:"1. Authentication"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"2 lo\u1ea1i user   ==> normal user                  ==> kubectl      \n                  (humans user)                ==> HTTP Request v\u1edbi token    \n\n              ==> service account user         ==> Service Account\n                  (d\xf9ng cho Pod)      \n"})}),"\n",(0,t.jsxs)(n.p,{children:["Tr\u01b0\u1edbc ti\xean, ch\xfang ta c\u1ea7n ph\xe2n bi\u1ec7t 2 lo\u1ea1i user \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong k8s ",(0,t.jsx)(n.code,{children:"service account user"})," v\xe0 ",(0,t.jsx)(n.code,{children:"normal user"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["normal user: \u0111\u1ea1i di\u1ec7n cho user c\u1ee7a ng\u01b0\u1eddi d\xf9ng, x\xe1c th\u1ef1c v\u1edbi K8S Cluster b\u1eb1ng d\u1ecbch v\u1ee5 b\xean ngo\xe0i (c\xf3 th\u1ec3 x\xe1c th\u1ef1c b\u1eb1ng certificate, username v\xe0 password, OAuth service, ...). Ng\u01b0\u1eddi d\xf9ng th\u01b0\u1eddng t\u01b0\u01a1ng t\xe1c K8S Cluster b\u1eb1ng vi\u1ec7c s\u1eed d\u1ee5ng ",(0,t.jsx)(n.code,{children:"kubectl"})," ho\u1eb7c ",(0,t.jsx)(n.code,{children:"HTTP Request"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["service account user: th\u01b0\u1eddng d\xf9ng cho process ch\u1ea1y trong pod. D\xf9ng resource ",(0,t.jsx)(n.code,{children:"service account"})," c\u1ee7a k8s \u0111\u1ec3 authentication - \u0111\xe2y l\xe0 d\u1ecbch v\u1ee5 authentication \u0111\u01b0\u1ee3c cung c\u1ea5p b\u1edfi K8S v\xe0 x\xe1c th\u1ef1c b\u1eb1ng token."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["L\u01b0u \xfd: C\xf3 th\u1ec3 m\u1ecdi ng\u01b0\u1eddi kh\xf4ng \u0111\u1ed3ng \xfd s\u1eed d\u1ee5ng ",(0,t.jsx)(n.code,{children:"Service Account resource"})," cho ",(0,t.jsx)(n.code,{children:"normal user"}),", nh\u01b0ng ch\u01b0a th\u1ea5y b\u1ea5t k\u1ef3 t\xe0i li\u1ec7u n\xe0o c\u1ee7a K8S vi\u1ebft r\u1eb1ng kh\xf4ng n\xean s\u1eed d\u1ee5ng cho ",(0,t.jsx)(n.code,{children:"normal user"}),". V\xec v\u1eady, t\xf4i ngh\u0129 ch\xfang ta c\xf3 th\u1ec3 s\u1eed d\u1ee5ng ",(0,t.jsx)(n.code,{children:"Service Account resource"})," \u0111\u1ec3 t\u1ea1o user cho vi\u1ec7c s\u1eed d\u1ee5ng ",(0,t.jsx)(n.code,{children:"kubectl"})," ho\u1eb7c ",(0,t.jsx)(n.code,{children:"HTTP Request"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["C\u1ea3 ",(0,t.jsx)(n.code,{children:"normal user"})," v\xe0 ",(0,t.jsx)(n.code,{children:"service account user"})," \u0111\u1ec1u ph\u1ea3i thu\u1ed9c m\u1ed9t ho\u1eb7c nhi\u1ec1u group. C\xf3 4 lo\u1ea1i group m\u1eb7c \u0111\u1ecbnh l\xe0"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["system",":unauthenticated"," - \u0111\u01b0\u1ee3c g\xe1n cho user kh\xf4ng authenticated th\xe0nh c\xf4ng."]}),"\n",(0,t.jsxs)(n.li,{children:["system",":authenticated"," - \u0111\u01b0\u1ee3c g\xe1n cho user authenticated th\xe0nh c\xf4ng."]}),"\n",(0,t.jsxs)(n.li,{children:["system",":serviceaccounts"," - group cho to\xe0n b\u1ed9 ServiceAccounts."]}),"\n",(0,t.jsx)(n.li,{children:"system:serviceaccounts:<namespace>  - group cho to\xe0n b\u1ed9 ServiceAccounts trong m\u1ed9t namespace."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"service-account",children:"Service Account"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Service Account l\xe0 m\u1ed9t resource c\u1ee7a k8s."}),"\n",(0,t.jsx)(n.li,{children:"Service Account n\xe0y l\xe0 m\u1ed9t namespace resouce, ngh\u0129a l\xe0 ch\u1ec9 c\xf3 scope b\xean trong m\u1ed9t namespace, ta kh\xf4ng th\u1ec3 d\xf9ng ServiceAccount c\u1ee7a namespace n\xe0y cho m\u1ed9t namespace kh\xe1c \u0111\u01b0\u1ee3c."}),"\n",(0,t.jsxs)(n.li,{children:["Service Account \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng cho pod s\u1ebd \u0111\u01b0\u1ee3c mount v\xe0o pod \u1edf path ",(0,t.jsx)(n.code,{children:"/var/run/secrets/kubernetes.io/serviceaccount"}),". M\u1eb7c \u0111\u1ecbnh m\u1ed7i namespace \u0111\u1ec1u c\xf3 1 service acocunt l\xe0 ",(0,t.jsx)(n.code,{children:"default"})," v\xe0 khi pod \u0111\u01b0\u1ee3c t\u1ea1o th\xec s\u1ebd s\u1eed d\u1ee5ng service account n\xe0y."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"external-service",children:"External Service"}),"\n",(0,t.jsxs)(n.p,{children:["Ngo\xe0i d\u1ecbch v\u1ee5 ",(0,t.jsx)(n.code,{children:"ServiceAccount"})," \u0111\u01b0\u1ee3c cung c\u1ea5p b\u1edfi K8S, ch\xfang ta c\xf3 th\u1ec3 s\u1eed d\u1ee5ng c\xe1c d\u1ecbch v\u1ee5 b\xean ngo\xe0i \u0111\u1ec3 ti\u1ebfn h\xe0nh x\xe1c th\u1ef1c v\u1edbi K8S nh\u01b0:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Static Token file."}),"\n",(0,t.jsx)(n.li,{children:"X.509 certificates."}),"\n",(0,t.jsx)(n.li,{children:"Open ID Connect."}),"\n",(0,t.jsx)(n.li,{children:"Authentication proxy."}),"\n",(0,t.jsx)(n.li,{children:"Webhook."}),"\n",(0,t.jsx)(n.li,{children:"..."}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"2-authorization-role-based-access-control",children:"2. Authorization (Role Based Access Control)"}),"\n",(0,t.jsxs)(n.p,{children:["N\u1ebfu nh\u01b0 service account v\xe0 c\xe1c ",(0,t.jsx)(n.code,{children:"external service"})," ch\u1ec9 d\xf9ng \u0111\u1ec3 authentication th\xec Role Based Access Control trong K8S s\u1ebd gi\xfap ch\xfang ta vi\u1ec7c Authorization cho c\xe1c ",(0,t.jsx)(n.code,{children:"normal user"})," ho\u1eb7c ",(0,t.jsx)(n.code,{children:"service account user"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"21-action",children:"2.1 Action"}),"\n",(0,t.jsx)(n.p,{children:"C\xe1c action c\xf3 th\u1ec3 th\u1ef1c hi\u1ec7n v\u1edbi RBAC th\xec nh\u01b0 sau"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Action"}),(0,t.jsx)(n.th,{children:"Verb"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"HEAD, GET"}),(0,t.jsx)(n.td,{children:"get"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"POST"}),(0,t.jsx)(n.td,{children:"create"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"PUT"}),(0,t.jsx)(n.td,{children:"update"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"PATCH"}),(0,t.jsx)(n.td,{children:"patch"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"DELETE"}),(0,t.jsx)(n.td,{children:"delete"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"22-c\xe1c-resource-\u0111\u1ec3-\u0111\u1ecbnh-ngh\u0129a-rbac",children:"2.2 C\xe1c resource \u0111\u1ec3 \u0111\u1ecbnh ngh\u0129a RBAC"}),"\n",(0,t.jsxs)(n.p,{children:["RBAC c\xf3 4 lo\u1ea1i resources ==> Roles: \u0111\u1ecbnh ngh\u0129a verb n\xe0o c\xf3 th\u1ec3 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n l\xean tr\xean namespace resource, s\u1ebd thu\u1ed9c namespace.",(0,t.jsx)(n.br,{}),"\n","==> ClusterRoles: \u0111\u1ecbnh ngh\u0129a verb n\xe0o c\xf3 th\u1ec3 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n l\xean tr\xean cluster resource, kh\xf4ng thu\u1ed9c b\u1ea5t k\u1ef3 m\u1ed9t namespace n\xe0o.",(0,t.jsx)(n.br,{}),"\n","==> RoleBindings: g\xe1n Roles t\u1edbi m\u1ed9t Service Account ho\u1eb7c user.",(0,t.jsx)(n.br,{}),"\n","==> ClusterRoleBindings: g\xe1n ClusterRoles t\u1edbi m\u1ed9t Service Account ho\u1eb7c user."]}),"\n",(0,t.jsx)(n.h1,{id:"3-v\xed-d\u1ee5",children:"3. V\xed d\u1ee5"}),"\n",(0,t.jsx)(n.h2,{id:"31-t\u1ea1o-user-trong-k8s-v\u1edbi-serviceaccount-role-rolebinding",children:"3.1 T\u1ea1o user trong K8S v\u1edbi ServiceAccount, Role, RoleBinding"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u0110\u1ea3m b\u1ea3o r\u1eb1ng RBAC \u0111\xe3 \u0111\u01b0\u1ee3c enabled"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"$ kubectl api-versions | grep rbac\nrbac.authorization.k8s.io/v1\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"T\u1ea1o m\u1ed9t Service Account resource"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"# ServiceAccount\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: demo-user-sa\n  namespace: default\n"})}),"\n",(0,t.jsx)(n.p,{children:"Apply v\xe0o K8S"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl apply -f demo-user-sa.yaml\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"T\u1ea1o role"}),(0,t.jsx)(n.br,{}),"\n","C\u1ea5u h\xecnh role b\xean d\u01b0\u1edbi cho ph\xe9p th\u1ef1c hi\u1ec7n c\xe1c h\xe0nh \u0111\u1ed9ng ",(0,t.jsx)(n.code,{children:"get, list, create, update"})," \u0111\u1ed1i v\u1edbi pods.\nChi ti\u1ebft:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:['apiGroup: [""] - \u0111i\u1ec1u n\xe0y ngh\u0129a l\xe0 role \xe1p d\u1ee5ng cho c\xe1c t\xe0i nguy\xean ',(0,t.jsx)(n.a,{href:"https://miro.medium.com/v2/resize:fit:1400/1*IqxBLalz8WP4ZJBM8uyx9g.png",children:"core API"})," c\u1ee7a Kubernetes nh\u01b0: pod, service, deployment, ..."]}),"\n",(0,t.jsx)(n.li,{children:"resources: [pods] - ch\u1ec9 \u0111\u1ecbnh c\u1ee5 th\u1ec3 lo\u1ea1i resource m\xe0 role n\xe0y \xe1p d\u1ee5ng l\xe0 pod, n\u1ebfu kh\xf4ng ch\u1ec9 \u0111\u1ecbnh resources th\xec Role s\u1ebd \xe1p d\u1ee5ng cho t\u1ea5t c\u1ea3 resouces trong core API."}),"\n",(0,t.jsx)(n.li,{children:"verbs: [get, list, create, update] - \u0111\u01a1n n\xe0y l\xe0 ch\u1ec9 \u0111\u1ecbnh c\xe1c lo\u1ea1i action m\xe0 role n\xe0y c\xf3 th\u1ec3 s\u1eed d\u1ee5ng."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'# Role\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: demo-role\n  namespace: default\nrules:\n  - apiGroups:\n      - ""\n    resources:\n      - pods\n    verbs:\n      - get\n      - list\n      - create\n      - update\n'})}),"\n",(0,t.jsx)(n.p,{children:"Apply v\xe0o K8S"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl apply -f demo-role.yaml\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"T\u1ea1o RoleBinding \u0111\u1ec3 g\xe1n Role cho ServiceAccount"}),(0,t.jsx)(n.br,{}),"\n","Role \u0111\xe3 \u0111\u01b0\u1ee3c t\u1ea1o nh\u01b0ng ch\u01b0a \u0111\u01b0\u1ee3c g\xe1n cho ServiceAccount. V\xec v\u1eady, ph\u1ea3i t\u1ea1o RoleBinding \u0111\u1ec3 g\xe1n Role cho ServiceAcocunt.",(0,t.jsx)(n.br,{}),"\n","Trong ph\u1ea7n \u0111\u1ecbnh ngh\u0129a c\u1ee7a RoleBinding, ch\xfang ta quan t\xe2m 2 th\xf4ng tin:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"roleRef"})," - X\xe1c \u0111\u1ecbnh ",(0,t.jsx)(n.code,{children:"Role"})," s\u1ebd \u0111\u01b0\u1ee3c g\xe1n."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"subjects"})," - Danh s\xe1ch m\u1ed9t ho\u1eb7c nhi\u1ec1u ",(0,t.jsx)(n.code,{children:"user"})," ho\u1eb7c ",(0,t.jsx)(n.code,{children:"ServiceAccount"})," \u0111\u1ec3 ch\u1ec9 \u0111\u1ecbnh ",(0,t.jsx)(n.code,{children:"Role"}),".\nC\u1ea5u h\xecnh b\xean d\u01b0\u1edbi g\xe1n Role ",(0,t.jsx)(n.code,{children:"demo-role"})," cho ServiceAccount ",(0,t.jsx)(n.code,{children:"demo-user-sa"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"# RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: demo-role-binding\n  namespace: default\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: demo-role\nsubjects:\n  - namespace: default\n    kind: ServiceAccount\n    name: demo-user\n\n"})}),"\n",(0,t.jsx)(n.p,{children:"Apply v\xe0o K8S"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl apply -f demo-role-binding.yaml\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Ti\u1ebfp theo, ch\xfang ta s\u1ebd ti\u1ebfn h\xe0nh l\u1ea5y token c\u1ee7a ServiceAccount v\u1eeba t\u1ea1o \u0111\u1ec3 c\u1ea5u h\xecnh context cho kubectl"}),(0,t.jsx)(n.br,{}),"\n","\u0110\u1ea7u ti\xean, l\u1ea5y token c\u1ee7a ServiceAccount \u0111\xe3 t\u1ea1o"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"$ TOKEN=$(kubectl create token demo-user-sa)\n"})}),"\n",(0,t.jsx)(n.p,{children:"Ti\u1ebfp theo, th\xeam ServiceAccount l\xe0 th\xf4ng tin x\xe1c th\u1ef1c c\u1ee7a c\u1ee7a context"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'$ kubectl config set-credentials demo-user --token=$TOKEN\nUser "demo-user" set.\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Ti\u1ebfn h\xe0nh t\u1ea1o ",(0,t.jsx)(n.code,{children:"context"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'$ kubectl config set-context demo-user-context --cluster=default --user=demo-user\nContext "demo-user-context" created.\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Tr\u01b0\u1edbc khi chuy\u1ec3n sang ",(0,t.jsx)(n.code,{children:"context"})," m\u1edbi, h\xe3y ki\u1ec3m tra ",(0,t.jsx)(n.code,{children:"context"})," \u0111ang s\u1eed d\u1ee5ng"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"$ kubectl config current-context\ndefault\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Chuy\u1ec3n t\u1eeb ",(0,t.jsx)(n.code,{children:"context"})," hi\u1ec7n t\u1ea1o sang ",(0,t.jsx)(n.code,{children:"context"})," v\u1eeba t\u1ea1o"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'$ kubectl config use-context demo-user-context\nSwitched to context "demo-user-context".\n'})}),"\n",(0,t.jsxs)(n.p,{children:["OK, b\xe2y gi\u1edd b\u1ea1n c\xf3 th\u1ec3 s\u1eed d\u1ee5ng ",(0,t.jsx)(n.code,{children:"context"})," m\u1edbi \u0111\u1ec3 list Pod trong namespace ",(0,t.jsx)(n.code,{children:"default"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"$ kubectl get pods\n"})}),"\n",(0,t.jsx)(n.p,{children:"Ch\xfang ta s\u1ebd th\u1eed list m\u1ed9t resource m\xe0 ch\u01b0a \u0111\u01b0\u1ee3c ph\xe2n quy\u1ec1n"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'$ kubectl get pods\nError from server (Forbidden): pods is forbidden: User "system:serviceaccount:default:demo-user-sa" cannot list resource "pods" in API group "" in the namespace "default"\n'})}),"\n",(0,t.jsx)(n.p,{children:"Ch\xfang ta s\u1ebd nh\u1eadn \u0111\u01b0\u1ee3c l\u1ed7i nh\u01b0 tr\xean."}),"\n",(0,t.jsx)(n.h2,{id:"32-t\u1ea1o-user-trong-k8s-v\u1edbi-certificate-role-rolebinding",children:"3.2 T\u1ea1o user trong K8S v\u1edbi Certificate, Role, RoleBinding"}),"\n",(0,t.jsxs)(n.p,{children:["\u1ede ph\u01b0\u01a1ng ph\xe1p n\xe0y ch\xfang ta s\u1ebd d\xf9ng X.509 Client Certificate \u0111\u1ec3 x\xe1c th\u1ef1c v\u1edbi K8S Cluster thay v\xec ServiceAccount.",(0,t.jsx)(n.br,{}),"\n","\u0110\xe2y l\xe0 m\u1ed9t trong nh\u1eefng c\xe1ch \u0111\u01a1n gi\u1ea3n nh\u1ea5t \u0111\u1ec3 x\xe1c th\u1ef1c ng\u01b0\u1eddi d\xf9ng v\u1edbi K8S Cluster.",(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.strong,{children:"\u0110\u1ea7u ti\xean, ch\xfang ta c\u1ea7n t\u1ea1o certificate cho user v\u1edbi OpenSSL"}),(0,t.jsx)(n.br,{}),"\n","Certificate g\u1ed3m 1 file private key v\xe0 1 file Certificate Signing Request (CSR)."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"openssl genrsa -out demo-user2.key 2048\nopenssl req -new -key demo-user2.key -out demo-user2.csr\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Ti\u1ebfn h\xe0nh k\xfd certificate d\u1ef1a tr\xean file CSR v\u1eeba t\u1ea1o v\xe0 Kubernetes cluster's CA"}),(0,t.jsx)(n.br,{}),"\n","Convert file ",(0,t.jsx)(n.code,{children:"csr"})," \u0111\xe3 t\u1ea1o \u1edf b\u01b0\u1edbc tr\u01b0\u1edbc th\xe0nh Certificate Signing Request (CSR) resource trong Kubernetes \u0111\u1ec3 Kubernetes cluster\u2019s CA c\xf3 th\u1ec3 k\xfd.",(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.code,{children:"request"})," field trong ",(0,t.jsx)(n.code,{children:"CertificateSigningRequest"})," resource nh\u1eadn \u0111\u1ecbnh d\u1ea1ng base64 kh\xf4ng c\xf3 kho\u1ea3ng tr\u1eafng n\xean ch\xfang ta c\u1ea7n convert file demo-user2.csr sang base64 v\xe0 b\u1ecf kho\u1ea3ng tr\u1eafng."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"cat <<EOF | kubectl apply -f -\napiVersion: certificates.k8s.io/v1\nkind: CertificateSigningRequest\nmetadata:\nname: demo-user2-csr\nspec:\nrequest: $(cat demo-user2.csr | base64 | tr -d '\\n')\nsignerName: kubernetes.io/kube-apiserver-client\nusages:\n- client auth\nEOF\n"})}),"\n",(0,t.jsx)(n.p,{children:"K\xfd"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl certificate approve demo-user2-csr\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"T\u1ea1o context cho kubectl"}),"\nL\u1ea5y certificate \u0111\xe3 k\xfd"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl get csr demo-user2-csr -o jsonpath='{.status.certificate}' | base64 -d > demo-user2.crt\n"})}),"\n",(0,t.jsx)(n.p,{children:"T\u1ea1o context"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'kubectl config set-credentials demo-user2 --client-certificate=demo-user2.crt --client-key=demo-user2.key\nkubectl config set-context demo-user2-context --cluster=default --user=demo-user2 -subj "/CN=USER-NAME"\nkubectl config use-context demo-user2-context\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Ti\u1ebfp theo, ch\xfang ta s\u1ebd ti\u1ebfn h\xe0nh ph\xe2n quy\u1ec1n cho user v\u1eeba t\u1ea1o b\u1eb1ng RBAC"}),"\n\u1ede \u0111\xe2y, \u0111\u1ec3 nhanh ch\xf3ng ch\xfang ta s\u1ebd t\u1ea1o RBAC v\xe0 assigned b\u1eb1ng ",(0,t.jsx)(n.code,{children:"kubectl command"})," thay v\xec t\u1ea1o file ",(0,t.jsx)(n.code,{children:"YAML"})," nh\u01b0 \u1edf ph\u1ea7n ServiceAccount.",(0,t.jsx)(n.br,{}),"\n","C\u1ea5u h\xecnh b\xean d\u01b0\u1edbi cho ph\xe9p ",(0,t.jsx)(n.code,{children:"demo-user2"})," user c\xf3 c\xe1c quy\u1ec1n get, list, watch, create, update \u0111\u1ed1i v\u1edbi c\xe1c pod \u1edf ",(0,t.jsx)(n.code,{children:"default"})," namespace."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl create role demo2-role --verb=get,list,watch,create,update --resource=pods --namespace=default\nkubectl create rolebinding demo2-role-binding --role=pod-reader --user=demo-user2 --namespace=default\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Cu\u1ed1i c\xf9ng, ki\u1ec3m tra user v\u1eeba t\u1ea1o"}),"\nV\u1edbi c\xe1c resource \u0111\xe3 \u0111\u01b0\u1ee3c ph\xe2n quy\u1ec1n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl get pods\n"})}),"\n",(0,t.jsx)(n.p,{children:"V\u1edbi c\xe1c resrouce ch\u01b0a \u0111\u01b0\u1ee3c ph\xe2n quy\u1ec1n"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"kubectl get svc\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"References:"}),(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.a,{href:"https://spacelift.io/blog/kubernetes-rbac",children:"https://spacelift.io/blog/kubernetes-rbac"}),(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.a,{href:"https://www.linkedin.com/pulse/create-user-kubernetes-kubectl-service-account-vikash-kumar-singh",children:"https://www.linkedin.com/pulse/create-user-kubernetes-kubectl-service-account-vikash-kumar-singh"}),(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/",children:"https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/"}),(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/authentication/",children:"https://kubernetes.io/docs/reference/access-authn-authz/authentication/"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://www.strongdm.com/blog/kubernetes-authentication",children:"https://www.strongdm.com/blog/kubernetes-authentication"}),(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.a,{href:"https://blog.nashtechglobal.com/creating-a-user-in-kubernetes/",children:"https://blog.nashtechglobal.com/creating-a-user-in-kubernetes/"}),(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.a,{href:"https://www.cncf.io/blog/2020/07/31/kubernetes-rbac-101-authentication/",children:"https://www.cncf.io/blog/2020/07/31/kubernetes-rbac-101-authentication/"}),(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.a,{href:"https://aungzanbaw.medium.com/a-step-by-step-guide-to-creating-users-in-kubernetes-6a5a2cfd8c71",children:"https://aungzanbaw.medium.com/a-step-by-step-guide-to-creating-users-in-kubernetes-6a5a2cfd8c71"}),(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.a,{href:"https://learnk8s.io/auth-authz",children:"https://learnk8s.io/auth-authz"})]})]})}function a(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453:(e,n,c)=>{c.d(n,{R:()=>i,x:()=>o});var t=c(6540);const r={},s=t.createContext(r);function i(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);