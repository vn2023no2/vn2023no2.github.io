"use strict";(self.webpackChunkvn_2023_no_2_github_io=self.webpackChunkvn_2023_no_2_github_io||[]).push([[6922],{9113:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>h,contentTitle:()=>o,default:()=>l,frontMatter:()=>c,metadata:()=>r,toc:()=>a});var i=s(5893),t=s(1151);const c={sidebar_position:4},o="1. Stiky session?",r={id:"IT/kubernetes/sticky-session",title:"1. Stiky session?",description:"Sticky sessions, c\xf2n \u0111\u01b0\u1ee3c g\u1ecdi l\xe0 session affinity, l\xe0 m\u1ed9t kh\xe1i ni\u1ec7m quan tr\u1ecdng trong loadbalancer , \u0111\u1ea3m b\u1ea3o c\xe1c y\xeau c\u1ea7u c\u1ee7a ng\u01b0\u1eddi d\xf9ng trong m\u1ed9t phi\xean lu\xf4n \u0111\u01b0\u1ee3c chuy\u1ec3n h\u01b0\u1edbng \u0111\u1ebfn c\xf9ng m\u1ed9t m\xe1y ch\u1ee7 trong m\u1ed9t kho\u1ea3ng th\u1eddi gian nh\u1ea5t \u0111\u1ecbnh. K\u1ef9 thu\u1eadt n\xe0y r\u1ea5t quan tr\u1ecdng trong c\xe1c t\xecnh hu\u1ed1ng m\xe0 d\u1eef li\u1ec7u phi\xean \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef c\u1ee5c b\u1ed9 tr\xean t\u1eebng m\xe1y ch\u1ee7.",source:"@site/docs/IT/5-kubernetes/sticky-session.md",sourceDirName:"IT/5-kubernetes",slug:"/IT/kubernetes/sticky-session",permalink:"/docs/IT/kubernetes/sticky-session",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IT/5-kubernetes/sticky-session.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"service-account-rbac",permalink:"/docs/IT/kubernetes/service-account-rbac"},next:{title:"Java",permalink:"/docs/category/java"}},h={},a=[{value:"2.1 Enabled \u1edf service",id:"21-enabled-\u1edf-service",level:2},{value:"2.2 Enabled \u1edf ingress",id:"22-enabled-\u1edf-ingress",level:2}];function d(n){const e={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,t.a)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.h1,{id:"1-stiky-session",children:"1. Stiky session?"}),"\n",(0,i.jsx)(e.p,{children:"Sticky sessions, c\xf2n \u0111\u01b0\u1ee3c g\u1ecdi l\xe0 session affinity, l\xe0 m\u1ed9t kh\xe1i ni\u1ec7m quan tr\u1ecdng trong loadbalancer , \u0111\u1ea3m b\u1ea3o c\xe1c y\xeau c\u1ea7u c\u1ee7a ng\u01b0\u1eddi d\xf9ng trong m\u1ed9t phi\xean lu\xf4n \u0111\u01b0\u1ee3c chuy\u1ec3n h\u01b0\u1edbng \u0111\u1ebfn c\xf9ng m\u1ed9t m\xe1y ch\u1ee7 trong m\u1ed9t kho\u1ea3ng th\u1eddi gian nh\u1ea5t \u0111\u1ecbnh. K\u1ef9 thu\u1eadt n\xe0y r\u1ea5t quan tr\u1ecdng trong c\xe1c t\xecnh hu\u1ed1ng m\xe0 d\u1eef li\u1ec7u phi\xean \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef c\u1ee5c b\u1ed9 tr\xean t\u1eebng m\xe1y ch\u1ee7."}),"\n",(0,i.jsx)(e.p,{children:"V\xed d\u1ee5 ph\u1ed5 bi\u1ebfn l\xe0 v\u1edbi c\xe1c \u1ee9ng d\u1ee5ng stateful khi to\xe0n b\u1ed9 d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c l\u01b0u trong t\u1eebng server v\xe0 d\u1eef li\u1ec7u kh\xf4ng chia s\u1ebb gi\u1eefa c\xe1c server v\u1edbi nhau. Khi \u0111\xf3 token authentication \u0111\u01b0\u1ee3c l\u01b0u v\xe0o session \u0111\u1ec3 x\xe1c nh\u1eadn ng\u01b0\u1eddi d\xf9ng \u0111\xe3 \u0111\u0103ng nh\u1eadp v\xe0o h\u1ec7 th\u1ed1ng, session l\u1ea1i \u0111\u01b0\u1ee3c l\u01b0u v\xe0o t\u1eebng server, \u0111i\u1ec1u n\xe0y khi\u1ebfn cho ng\u01b0\u1eddi d\xf9ng \u0111\xe3 \u0111\u0103ng nh\u1eadp b\u1ecb \u0111\u0103ng xu\u1ea5t ra khi request c\u1ee7a h\u1ecd b\u1ecb \u0111i\u1ec1u h\u01b0\u1edbng sang server web kh\xe1c v\u1edbi server nh\u1eadn request \u0111\u0103ng nh\u1eadp c\u1ee7a h\u1ecd."}),"\n",(0,i.jsx)(e.h1,{id:"2-enabled-sticky-session-trong-kubernetes",children:"2. Enabled sticky session trong kubernetes"}),"\n",(0,i.jsx)(e.p,{children:"Trong kubernetes c\xf3 2 c\xe1ch \u0111\u1ec3 c\xf3 th\u1ec3 c\u1ea5u h\xecnh \u0111\u01b0\u1ee3c sticky session."}),"\n",(0,i.jsx)(e.h2,{id:"21-enabled-\u1edf-service",children:"2.1 Enabled \u1edf service"}),"\n",(0,i.jsxs)(e.p,{children:["C\u1ea5u h\xecnh \u1edf t\u1ea7ng service ch\u1ec9 ho\u1ea1t \u0111\u1ed9ng \u1edf layer 4 (TCP/UDP) n\xean ch\u1ec9 c\xf3 th\u1ec3 \u0111\u1ecbnh tuy\u1ebfn d\u1ef1a tr\xean IP c\u1ee7a Client. V\xec v\u1eady, c\u1ea7n \u0111\u1ea3m b\u1ea3o r\u1eb1ng IP m\xe0 service nh\u1eadn \u0111\u01b0\u1ee3c l\xe0 IP c\u1ee7a Client.",(0,i.jsx)(e.br,{}),"\n","Do \u0111\xf3, c\xe1ch c\u1ea5u h\xecnh n\xe0y th\u01b0\u1eddng ph\xf9 h\u1ee3p cho c\xe1c d\u1ecbch v\u1ee5 truy c\u1eadp tr\u1ef1c ti\u1ebfp v\xe0o kubernetes qua ",(0,i.jsx)(e.code,{children:"service"})," (th\u01b0\u1eddng \u0111\u01b0\u1ee3c c\u1ea5u h\xecnh ",(0,i.jsx)(e.code,{children:"service type"})," l\xe0 ",(0,i.jsx)(e.code,{children:"ClusterIP"})," ho\u1eb7c ",(0,i.jsx)(e.code,{children:"LoadBalancer"}),").",(0,i.jsx)(e.br,{}),"\n","C\u1ea7n \u0111\u1ea3m b\u1ea3o c\xe1c property n\xe0o c\xf3 trong c\u1ea5u h\xecnh c\u1ee7a service."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"# The following adds session affinity\nsessionAffinity: ClientIP\nsessionAffinityConfig:\nclientIP:\n    timeoutSeconds: 600 \n"})}),"\n",(0,i.jsx)(e.p,{children:"V\xed d\u1ee5:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"kind: Service\napiVersion: v1\nmetadata:\n  name: myservice\nspec:\n  selector:\n    app: myapp\n  ports:\n  - name: http\n    protocol: TCP\n    port: 80\n    targetPort: 80\n  # The following adds session affinity\n  sessionAffinity: ClientIP\n  sessionAffinityConfig:\n    clientIP:\n      timeoutSeconds: 600 \n"})}),"\n",(0,i.jsx)(e.h2,{id:"22-enabled-\u1edf-ingress",children:"2.2 Enabled \u1edf ingress"}),"\n",(0,i.jsxs)(e.p,{children:["Kh\xf4ng gi\u1ed1ng nh\u01b0 ",(0,i.jsx)(e.code,{children:"Service"}),", ",(0,i.jsx)(e.code,{children:"Ingress"})," ho\u1ea1t \u0111\u1ed9ng \u1edf layer 7 (HTTP) v\xec th\u1ebf c\xe1c b\u1ea1n c\xf3 th\u1ec3 \u0111\u1ecbnh tuy\u1ebfn traffic d\u1ef1 tr\xean HTTP session, paths, headers, ...\n\u0110\u1ec3 c\u1ea5u h\xecnh Sticky Session \u1edf ingress, c\u1ea7n \u0111\u1ea3m b\u1ea3o c\xe1c annotations sau c\xf3 trong ingress"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'nginx.ingress.kubernetes.io/affinity: "cookie" \nnginx.ingress.kubernetes.io/session-cookie-name: "route" \nnginx.ingress.kubernetes.io/session-cookie-max-age: "172800" \n'})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:'nginx.ingress.kubernetes.io/affinity: "cookie"'})," - lo\u1ea1i affinity, \u0111\u1ec3 l\xe0 ",(0,i.jsx)(e.code,{children:"cookie"})," \u0111\u1ec3 b\u1eadt sticky session.",(0,i.jsx)(e.br,{}),"\n",(0,i.jsx)(e.code,{children:'nginx.ingress.kubernetes.io/session-cookie-name: "route"'})," - t\xean c\u1ee7a cookie (m\u1eb7c \u0111\u1ecbnh l\xe0 ",(0,i.jsx)(e.code,{children:"INGRESSCOOKIE"}),").",(0,i.jsx)(e.br,{}),"\n",(0,i.jsx)(e.code,{children:'nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"'})," - th\u1eddi gian cookie expired (second)."]}),"\n",(0,i.jsxs)(e.p,{children:["M\u1ed9t s\u1ed1 c\xe1c annotations kh\xe1c \u0111\u1ec3 c\u1ea5u h\xecnh stick session cho ingress b\u1ea1n c\xf3 th\u1ec3 xem \u1edf ",(0,i.jsx)(e.a,{href:"https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/",children:"\u0111\xe2y"})]}),"\n",(0,i.jsx)(e.p,{children:"M\u1eb7c d\xf9 c\u1ea5u h\xecnh sticky session \u0111em l\u1ea1i nhi\u1ec1u l\u1ee3i \xedch nh\u01b0ng n\xf3 c\u0169ng c\xf3 th\u1ec3 g\xe2y ra t\xecnh tr\u1ea1ng m\u1ed9t Pod s\u1eed d\u1ee5ng nhi\u1ec1u resource h\u01a1n c\xe1c pod c\xf2n l\u1ea1i khi c\xe1c request t\u1eeb client b\u1ecb k\u1eb9t session \u1edf pod n\xe0y. T\u01b0\u1edfng t\u01b0\u1ee3ng khi b\u1ea1n kh\u1edfi \u0111\u1ed9ng l\u1ea1i c\xe1c pod v\xe0 pod \u0111\u1ea7u ti\xean running s\u1ebd nh\u1eadn m\u1ed9t l\u01b0\u1ee3ng l\u1edbn request t\u1eeb Client v\xe0 sau \u0111\xf3 c\xe1c request t\u1eeb Client n\xe0y s\u1ebd ch\u1ec9 v\xe0o Pod \u0111\u1ea7u ti\xean d\u1eabn \u0111\u1ebfn Pod n\xe0y s\u1eed d\u1ee5ng nhi\u1ec1u resource h\u01a1n c\xe1c pod c\xf2n l\u1ea1i."}),"\n",(0,i.jsx)(e.p,{children:"V\xec th\u1ebf \u0111\xe2y c\u0169ng l\xe0 m\u1ed9t v\u1ea5n \u0111\u1ec1 c\xe1c b\u1ea1n c\u1ea7n c\xe2n nh\u1eafc khi s\u1eed d\u1ee5ng stick session."}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"References:"}),(0,i.jsx)(e.br,{}),"\n",(0,i.jsx)(e.a,{href:"https://docs.mirantis.com/mke/3.8/ops/deploy-apps-k8s/nginx-ingress/configure-sticky-session.html",children:"https://docs.mirantis.com/mke/3.8/ops/deploy-apps-k8s/nginx-ingress/configure-sticky-session.html"}),(0,i.jsx)(e.br,{}),"\n",(0,i.jsx)(e.a,{href:"https://pauldally.medium.com/session-affinity-and-kubernetes-proceed-with-caution-8e66fd5deb05",children:"https://pauldally.medium.com/session-affinity-and-kubernetes-proceed-with-caution-8e66fd5deb05"}),(0,i.jsx)(e.br,{}),"\n",(0,i.jsx)(e.a,{href:"https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/",children:"https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/"}),(0,i.jsx)(e.br,{}),"\n",(0,i.jsx)(e.a,{href:"https://dev.to/danielepolencic/sticky-sessions-and-canary-releases-in-kubernetes-5a92",children:"https://dev.to/danielepolencic/sticky-sessions-and-canary-releases-in-kubernetes-5a92"}),(0,i.jsx)(e.br,{}),"\n",(0,i.jsx)(e.a,{href:"https://kubernetes.io/docs/reference/networking/virtual-ips/#session-affinity",children:"https://kubernetes.io/docs/reference/networking/virtual-ips/#session-affinity"}),(0,i.jsx)(e.br,{}),"\n",(0,i.jsx)(e.a,{href:"https://docs.vngcloud.vn/vng-cloud-document/vn/vserver/compute-hcm03-1a/vlb-load-balancer-new-version/application-load-balancer/pool/enable-sticky-session",children:"https://docs.vngcloud.vn/vng-cloud-document/vn/vserver/compute-hcm03-1a/vlb-load-balancer-new-version/application-load-balancer/pool/enable-sticky-session"})]})]})}function l(n={}){const{wrapper:e}={...(0,t.a)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},1151:(n,e,s)=>{s.d(e,{Z:()=>r,a:()=>o});var i=s(7294);const t={},c=i.createContext(t);function o(n){const e=i.useContext(c);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:o(n.components),i.createElement(c.Provider,{value:e},n.children)}}}]);